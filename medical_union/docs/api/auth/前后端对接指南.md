# 前后端对接指南

## 概述

本指南为Medical Union系统认证模块的前后端对接提供详细说明，包括API文档使用、Postman测试集合导入、常见问题解决等内容。

---

## 📁 文档结构说明

```
docs/api/
├── README.md                                   # API文档总览
├── auth/                                       # 认证模块文档
│   ├── auth-api.md                            # 📋 API接口详细文档
│   ├── auth-models.md                         # 🏗️ 数据模型定义
│   ├── auth-examples.md                       # 📝 请求响应示例
│   ├── Medical_Union_Auth_API.postman_collection.json     # 📮 Postman测试集合
│   └── Medical_Union_Development.postman_environment.json # 🔧 Postman环境配置
└── common/                                     # 公共文档
    ├── response-format.md                      # 📄 统一响应格式规范
    └── error-codes.md                         # ⚠️ 错误代码说明
```

---

## 🚀 快速开始

### 步骤1：导入Postman集合

1. **打开Postman应用**
2. **导入API集合**：
   - 点击左上角 "Import" 按钮
   - 选择文件：`docs/api/auth/Medical_Union_Auth_API.postman_collection.json`
   - 点击 "Import" 完成导入

3. **导入环境配置**：
   - 点击右上角齿轮图标（环境管理）
   - 点击 "Import"
   - 选择文件：`docs/api/auth/Medical_Union_Development.postman_environment.json`
   - 导入后选择 "Medical Union - 开发环境"

### 步骤2：启动后端服务

确保Spring Boot应用已启动并运行在 `http://localhost:8080`

### 步骤3：执行测试流程

按以下顺序执行API测试：

1. **用户注册** → 自动保存用户ID
2. **用户登录** → 自动保存JWT Token
3. **获取用户信息** → 验证完整流程

---

## 📖 文档使用指南

### 前端开发者

#### 1. API接口文档 (`auth-api.md`)
- **用途**：了解接口URL、请求参数、响应格式
- **重点关注**：
  - 请求参数验证规则
  - JWT Token使用方式
  - 错误处理机制

#### 2. 数据模型文档 (`auth-models.md`)
- **用途**：创建TypeScript/JavaScript类型定义
- **重点关注**：
  - 请求对象结构
  - 响应对象字段
  - 数据验证规则

**TypeScript类型定义示例**：
```typescript
// 基于auth-models.md创建的类型定义
interface ApiResponse<T = any> {
    success: boolean;
    code: number;
    message: string;
    data: T | null;
}

interface LoginRequest {
    phone: string;
    password: string;
    userType: 'PATIENT' | 'DOCTOR' | 'ADMIN';
}

interface LoginResponse {
    userId: number;
    username: string;
    role: string;
    profileJson: string | null;
    token: string;
}
```

#### 3. 响应格式规范 (`response-format.md`)
- **用途**：统一错误处理逻辑
- **重点关注**：
  - 成功/失败判断标准
  - 分页数据格式
  - 时间格式规范

#### 4. 错误代码说明 (`error-codes.md`)
- **用途**：实现统一的错误处理
- **重点关注**：
  - 错误码分类体系
  - 用户友好的错误提示
  - 错误处理最佳实践

### 后端开发者

#### 1. 请求响应示例 (`auth-examples.md`)
- **用途**：验证API实现正确性
- **重点关注**：
  - 各种场景的响应格式
  - 异常情况处理
  - 性能测试建议

#### 2. Postman测试集合
- **用途**：API功能测试和回归测试
- **包含功能**：
  - 自动化测试脚本
  - 响应格式验证
  - 数据一致性检查

---

## 🔧 环境配置

### 开发环境变量

| 变量名 | 默认值 | 描述 | 自动设置 |
|--------|---------|------|----------|
| baseUrl | http://localhost:8080 | API服务器地址 | ❌ |
| jwt_token | 空 | JWT访问令牌 | ✅ 登录时 |
| userId | 空 | 当前用户ID | ✅ 注册时 |
| current_username | 空 | 当前用户名 | ✅ 登录时 |
| api_timeout | 30000 | 请求超时(ms) | ❌ |

### 多环境支持

可以创建多个环境配置用于不同部署阶段：

- **开发环境**：`http://localhost:8080`
- **测试环境**：`http://test-api.medicalunion.com`
- **生产环境**：`https://api.medicalunion.com`

---

## 🔍 测试指南

### API自动化测试

每个接口都包含自动化测试脚本：

```javascript
// 示例：登录接口测试脚本
pm.test("Status code is 200", function () {
    pm.response.to.have.status(200);
});

pm.test("Response contains JWT token", function () {
    const responseJson = pm.response.json();
    pm.expect(responseJson.data).to.have.property('token');
    pm.expect(responseJson.data.token).to.not.be.empty;
});

// 自动保存token供后续使用
if (pm.response.code === 200) {
    const responseJson = pm.response.json();
    pm.environment.set("jwt_token", responseJson.data.token);
}
```

### 测试数据生成

使用Postman动态变量生成测试数据：

- `{{$randomFirstName}}`: 随机姓名
- `{{$randomInt}}`: 随机数字
- `{{$randomInt(10000000,99999999)}}`: 指定范围随机数

### 完整测试流程

```bash
# 1. 注册测试用户
POST /api/v1/auth/register
{
    "username": "test_{{$randomInt}}",
    "password": "password123",
    "role": "PATIENT",
    "phone": "139{{$randomInt(10000000,99999999)}}"
}

# 2. 登录获取token
POST /api/v1/auth/login
{
    "phone": "{{registered_phone}}",
    "password": "password123",
    "userType": "PATIENT"
}

# 3. 获取用户信息验证token
GET /api/v1/auth/user/info
Headers: Authorization: Bearer {{jwt_token}}
```

---

## ❗ 常见问题解决

### 1. JWT Token相关

**问题**：Token无效或过期
```json
{
    "success": false,
    "code": 1203,
    "message": "Token已过期"
}
```

**解决方案**：
- 前端：检查token是否正确保存
- 后端：确认JWT签名密钥配置
- 测试：重新执行登录接口获取新token

### 2. 跨域问题

**问题**：浏览器CORS错误

**解决方案**：
```java
// Spring Boot CORS配置
@CrossOrigin(origins = "http://localhost:3000")
@RestController
public class AuthController {
    // ...
}
```

### 3. 参数验证失败

**问题**：400错误，参数格式不正确

**解决方案**：
- 检查请求Content-Type是否为`application/json`
- 确认参数名称和类型匹配API文档
- 查看`auth-models.md`确认验证规则

### 4. 数据库连接问题

**问题**：500错误，无法连接数据库

**解决方案**：
- 检查MySQL服务是否启动
- 确认`application.yml`数据库配置
- 验证存储过程是否已创建

---

## 🔄 版本更新流程

### API版本管理

1. **向后兼容变更**：直接更新文档
2. **破坏性变更**：创建新版本API
3. **文档同步**：代码变更后及时更新文档

### 文档更新检查清单

- [ ] API接口文档更新
- [ ] 数据模型定义更新
- [ ] 错误代码添加/修改
- [ ] Postman集合更新
- [ ] 示例代码更新
- [ ] 版本号递增

---

## 📞 技术支持

### 联系方式

- **开发团队邮箱**：dev@medicalunion.com
- **技术支持电话**：400-xxx-xxxx
- **问题反馈**：提交GitHub Issue或内部工单

### 文档反馈

如发现文档问题或需要补充内容，请：

1. 📧 发送邮件说明问题
2. 🔧 提供具体的修改建议
3. ✅ 确认修改后的准确性

---

## 🎯 最佳实践

### 前端集成建议

1. **统一错误处理**：
```javascript
// 封装API调用
async function apiCall(url, options) {
    try {
        const response = await fetch(url, options);
        const result = await response.json();
        
        if (!result.success) {
            throw new ApiError(result.code, result.message);
        }
        
        return result.data;
    } catch (error) {
        handleApiError(error);
        throw error;
    }
}
```

2. **Token自动管理**：
```javascript
// 请求拦截器添加token
axios.interceptors.request.use(config => {
    const token = localStorage.getItem('jwt_token');
    if (token) {
        config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
});
```

3. **响应拦截处理**：
```javascript
// 响应拦截器处理token过期
axios.interceptors.response.use(
    response => response,
    error => {
        if (error.response?.data?.code === 1203) {
            // Token过期，跳转登录页
            localStorage.removeItem('jwt_token');
            router.push('/login');
        }
        return Promise.reject(error);
    }
);
```

### 后端开发建议

1. **统一异常处理**：使用`@RestControllerAdvice`
2. **参数验证**：使用`@Valid`和自定义验证器
3. **日志记录**：记录关键操作和错误信息
4. **性能监控**：监控API响应时间和错误率

---

## 📈 测试报告

使用Postman的Newman工具可以生成自动化测试报告：

```bash
# 安装Newman
npm install -g newman

# 运行测试集合
newman run Medical_Union_Auth_API.postman_collection.json \
  -e Medical_Union_Development.postman_environment.json \
  --reporters html \
  --reporter-html-export test-report.html
```

---

📝 **最后更新**：2025年9月24日  
🏷️ **文档版本**：v1.0.0  
👥 **维护团队**：Medical Union 开发团队