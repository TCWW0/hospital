# Auth模块存储过程接口规范

## 概述
本文档定义了医院管理系统Auth模块所需的存储过程接口规范，包括输入输出参数、错误码约定和业务逻辑要求。

## 接口设计原则
1. **统一输出格式**：所有存储过程都使用OUT参数返回`errcode`（整数）和`errmsg`（字符串）
2. **错误码标准化**：使用统一的错误码体系，详见`error-codes.md`
3. **事务完整性**：每个存储过程内部处理完整的业务事务
4. **参数校验**：存储过程内部进行必要的参数校验
5. **安全性**：密码相关操作考虑安全性要求

---

## 1. 用户注册存储过程

### 过程名称：`sp_user_register`

### 功能描述
注册新用户到系统中，支持普通用户角色的注册。

### 输入参数（IN）
| 参数名 | 类型 | 长度 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|------|
| `p_username` | VARCHAR | 100 | 是 | 用户名（唯一） | 'zhang_san' |
| `p_password_hash` | VARCHAR | 255 | 是 | 密码哈希值（BCrypt） | '$2a$10$...' |
| `p_role` | VARCHAR | 32 | 是 | 用户角色 | 'PATIENT', 'DOCTOR', 'ADMIN' |
| `p_phone` | VARCHAR | 20 | 否 | 手机号码 | '13812345678' |
| `p_id_number` | VARCHAR | 64 | 否 | 身份证号码 | '110101199001011234' |
| `p_profile_json` | TEXT | - | 否 | 用户配置信息（JSON格式） | '{"nickname":"张三"}' |

### 输出参数（OUT）
| 参数名 | 类型 | 描述 | 成功示例 | 错误示例 |
|--------|------|------|----------|----------|
| `p_user_id` | INT | 新创建用户的ID | 1001 | NULL |
| `p_errcode` | INT | 错误码（0=成功） | 0 | 1001 |
| `p_errmsg` | VARCHAR(255) | 错误信息 | 'SUCCESS' | '用户名已存在' |

### 业务逻辑要求
1. **唯一性校验**：
   - 检查`username`是否已存在
   - 检查`id_number`是否已存在（如果提供）
   - 检查`phone`是否已存在（如果提供）

2. **数据验证**：
   - `username`：长度3-100字符，只能包含字母、数字、下划线
   - `role`：必须是预定义的角色值
   - `phone`：如果提供，必须是有效的手机号格式
   - `id_number`：如果提供，必须是有效的身份证号格式

3. **默认值处理**：
   - `role`默认为'PATIENT'
   - `created_at`和`updated_at`设为当前时间

### 错误码
- `0`：成功
- `1001`：用户名已存在
- `1002`：身份证号已存在
- `1003`：手机号已存在
- `1004`：参数验证失败
- `9999`：数据库内部错误

---

## 2. 用户登录存储过程

### 过程名称：`sp_user_login`

### 功能描述
验证用户登录凭证，返回用户基本信息。支持用户名或手机号登录。

### 输入参数（IN）
| 参数名 | 类型 | 长度 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|------|
| `p_login_name` | VARCHAR | 100 | 是 | 登录名（用户名或手机号） | 'zhang_san' 或 '13812345678' |
| `p_password` | VARCHAR | 255 | 是 | 明文密码 | 'password123' |
| `p_user_type` | VARCHAR | 32 | 否 | 期望的用户类型（可选过滤） | 'PATIENT' |

### 输出参数（OUT）
| 参数名 | 类型 | 描述 | 成功示例 | 错误示例 |
|--------|------|------|----------|----------|
| `p_user_id` | INT | 用户ID | 1001 | NULL |
| `p_username` | VARCHAR(100) | 用户名 | 'zhang_san' | NULL |
| `p_role` | VARCHAR(32) | 用户角色 | 'PATIENT' | NULL |
| `p_profile_json` | TEXT | 用户配置信息 | '{"nickname":"张三"}' | NULL |
| `p_last_login_at` | TIMESTAMP | 上次登录时间 | '2025-09-23 10:30:00' | NULL |
| `p_errcode` | INT | 错误码（0=成功） | 0 | 2001 |
| `p_errmsg` | VARCHAR(255) | 错误信息 | 'SUCCESS' | '用户名或密码错误' |

### 业务逻辑要求
1. **登录名识别**：
   - 自动识别`p_login_name`是用户名还是手机号
   - 支持两种方式登录

2. **密码验证**：
   - 使用BCrypt验证明文密码与存储的哈希值
   - 验证失败不要暴露具体是用户名还是密码错误

3. **用户类型过滤**：
   - 如果提供`p_user_type`，验证用户角色是否匹配
   - 不匹配时返回登录失败

4. **登录记录**：
   - 成功登录后更新用户的`updated_at`字段
   - 记录登录时间（可选）

### 错误码
- `0`：成功
- `2001`：用户名或密码错误
- `2002`：用户类型不匹配
- `2003`：用户账户已禁用
- `2004`：参数验证失败
- `9999`：数据库内部错误

---

## 3. 用户信息查询存储过程

### 过程名称：`sp_user_get_info`

### 功能描述
根据用户ID获取用户详细信息，用于JWT token验证后的用户信息获取。

### 输入参数（IN）
| 参数名 | 类型 | 长度 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|------|
| `p_user_id` | INT | - | 是 | 用户ID | 1001 |

### 输出参数（OUT）
| 参数名 | 类型 | 描述 | 成功示例 | 错误示例 |
|--------|------|------|----------|----------|
| `p_username` | VARCHAR(100) | 用户名 | 'zhang_san' | NULL |
| `p_role` | VARCHAR(32) | 用户角色 | 'PATIENT' | NULL |
| `p_phone` | VARCHAR(20) | 手机号 | '13812345678' | NULL |
| `p_id_number` | VARCHAR(64) | 身份证号 | '110101199001011234' | NULL |
| `p_profile_json` | TEXT | 用户配置信息 | '{"nickname":"张三"}' | NULL |
| `p_created_at` | TIMESTAMP | 创建时间 | '2025-09-20 10:00:00' | NULL |
| `p_errcode` | INT | 错误码（0=成功） | 0 | 3001 |
| `p_errmsg` | VARCHAR(255) | 错误信息 | 'SUCCESS' | '用户不存在' |

### 业务逻辑要求
1. **存在性检查**：验证用户ID是否存在
2. **安全性**：不返回密码相关信息
3. **完整性**：返回用户的所有基本信息

### 错误码
- `0`：成功
- `3001`：用户不存在
- `3002`：用户已禁用
- `9999`：数据库内部错误

---

## 调用约定

### 1. 事务处理
- 每个存储过程内部处理完整事务
- 发生错误时自动回滚
- 成功时自动提交

### 2. 异常处理
- 捕获所有数据库异常
- 返回统一的错误码和错误信息
- 不向外抛出未处理的异常

### 3. 日志记录
- 记录关键操作的审计日志
- 记录错误信息用于调试

### 4. 性能要求
- 单次调用响应时间 < 100ms
- 支持并发调用
- 使用适当的数据库索引

---

## 测试要求

### 1. 功能测试
- 正常流程测试
- 边界条件测试
- 异常情况测试

### 2. 性能测试
- 并发调用测试
- 大数据量测试

### 3. 安全测试
- SQL注入测试
- 密码安全测试

---

## 变更记录
| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2025-09-23 | 初始版本 | 后端工程师 |
