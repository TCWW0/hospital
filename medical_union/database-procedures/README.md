# 数据库存储过程文档目录

## 概述
本目录包含医院管理系统Auth模块所需的数据库存储过程的完整文档和模板，用于指导数据库端的实现工作。

## 目录结构
```
database-procedures/
├── README.md                                    # 本文件
├── specifications/                              # 规范文档目录
│   ├── auth-procedures-spec.md                  # Auth模块存储过程接口规范
│   ├── error-codes.md                           # 统一错误码规范
│   ├── implementation-requirements.md           # 实现需求详细说明
│   ├── sp_user_register_template.sql           # 用户注册存储过程模板
│   ├── sp_user_login_template.sql              # 用户登录存储过程模板
│   └── sp_user_get_info_template.sql           # 用户信息查询存储过程模板
└── implementations/                             # 实现文件目录（您需要填充）
    ├── README.md                                # 实现说明文档
    ├── sp_user_register.sql                    # 用户注册存储过程实现
    ├── sp_user_login.sql                       # 用户登录存储过程实现
    └── sp_user_get_info.sql                    # 用户信息查询存储过程实现
```

## 文档说明

### specifications/ 目录（规范文档）

#### 1. auth-procedures-spec.md
- **目的**：定义Auth模块所需的3个存储过程的接口规范
- **内容**：
  - 输入输出参数详细定义
  - 业务逻辑要求
  - 错误码约定
  - 调用约定和性能要求

#### 2. error-codes.md  
- **目的**：建立Java端和数据库端的统一错误码体系
- **内容**：
  - 错误码分段规则
  - Auth模块完整错误码定义
  - Java端ErrorCode枚举设计
  - HTTP状态码映射关系

#### 3. implementation-requirements.md
- **目的**：为数据库开发人员提供详细的实现指导
- **内容**：
  - 业务需求详解
  - 技术实现要求
  - 性能和安全要求
  - 测试验收标准

#### 4. 存储过程模板文件
- **sp_user_register_template.sql**：用户注册存储过程完整模板
- **sp_user_login_template.sql**：用户登录存储过程完整模板  
- **sp_user_get_info_template.sql**：用户信息查询存储过程完整模板

每个模板都包含：
- 完整的参数定义
- 业务逻辑实现框架
- 错误处理机制
- 使用示例

### implementations/ 目录（待您实现）

这个目录是您需要填充的实现文件存放位置：

#### 需要实现的存储过程：
1. **sp_user_register.sql** - 用户注册
   - 实现用户注册的完整业务逻辑
   - 包括参数验证、唯一性检查、数据插入

2. **sp_user_login.sql** - 用户登录
   - 实现用户登录验证
   - 支持用户名和手机号登录
   - 返回用户信息供JWT生成

3. **sp_user_get_info.sql** - 用户信息查询
   - 根据用户ID获取用户详细信息
   - 支持数据脱敏选项

#### 实现要求：
- 严格按照规范文档中的接口定义实现
- 使用统一的错误码体系
- 包含完整的错误处理机制
- 满足性能和安全要求

## 开发流程

### 阶段1：需求理解
1. 仔细阅读 `auth-procedures-spec.md` 了解接口要求
2. 研读 `error-codes.md` 理解错误码体系
3. 查看 `implementation-requirements.md` 了解业务需求

### 阶段2：参考模板
1. 查看对应的模板文件了解实现结构
2. 理解错误处理机制
3. 参考使用示例

### 阶段3：编写实现
1. 在 `implementations/` 目录下创建对应的SQL文件
2. 按照模板结构编写存储过程
3. 实现完整的业务逻辑和错误处理

### 阶段4：测试验证
1. 使用文档中的测试用例验证功能
2. 确保错误码返回正确
3. 验证性能指标

### 阶段5：交付集成
1. 通知Java端开发人员实现完成
2. 配合进行集成测试
3. 根据测试结果进行优化调整

## 技术要点

### 密码处理策略
由于BCrypt在MySQL中实现复杂，采用以下策略：
- **注册**：直接存储Java端传入的BCrypt哈希值
- **登录**：存储过程返回哈希值，由Java端进行BCrypt验证

### JSON数据处理
- 使用MySQL的JSON函数处理profile字段
- 支持手机号等信息的JSON存储和查询
- 提供JSON格式验证

### 事务管理
- 每个存储过程内部处理完整事务
- 统一的异常处理和回滚机制
- 合理的锁策略避免死锁

### 性能优化
- 合理使用数据库索引
- 避免不必要的全表扫描
- 控制事务范围和锁时间

## 联系方式

实现过程中如有疑问，请：
1. 首先查阅相关文档
2. 参考模板文件中的实现方式
3. 与Java端开发人员沟通接口细节

## 变更记录
| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2025-09-23 | 初始文档创建，包含完整的规范和模板 | 后端工程师 |